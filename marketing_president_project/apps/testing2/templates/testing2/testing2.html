{% extends 'base.html' %}

{% block title %}
  Testing Tabs
{% endblock %}

{% block content %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <div class="container py-4">
    <h1 class="mb-4">Halaman Testing Tabs</h1>

    <ul class="nav nav-tabs mb-4" id="testingTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form" type="button" role="tab">Filter</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">Upload</button>
      </li>
    </ul>

    <div class="tab-content" id="testingTabsContent">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}


      {% if not result %}
        <div class="alert alert-warning">
          Silakan upload dataset terlebih dahulu untuk mengaktifkan fitur filter.
        </div>
      {% endif %}
      
      <!-- Form Tab -->
      <div class="tab-pane fade show active" id="form" role="tabpanel" aria-labelledby="form-tab">
        <!-- Filter Prediksi -->
        <div class="card p-4 mt-5">
          <h5>Filter Hasil Prediksi</h5>
          <form method="POST" action="{% url 'testing2:filter_prediksi' %}">
            {% csrf_token %}

            <!-- Country -->
            <div class="mb-3">
              <label for="country" class="form-label">Country</label>
              <select id="country" name="country" class="form-select" onchange="toggleProvince(this.value)" {% if not result %}disabled{% endif %}>
                <option value="">Semua</option>
                {% for c in countries %}
                  <option value="{{ c.idcountrydata }}">{{ c.countryname }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Provinsi -->
            <div class="mb-3" id="provinsi-group" style="display: none;">
              <label for="provinsi" class="form-label">Provinsi</label>
              <select id="provinsi" name="provinsi" class="form-select" onchange="filterRegencies(this.value)">
                <option value="">Semua</option>
                {% for p in provinces %}
                  <option value="{{ p.id }}">{{ p.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Kota/Kabupaten -->
            <div class="mb-3" id="kota-group" style="display: none;">
              <label for="regency" class="form-label">Kabupaten/Kota</label>
              <select id="regency" name="regency" class="form-select">
                <option value="">Semua</option>
                {% for r in regencies %}
                  <option value="{{ r.id }}" data-prov-id="{{ r.province_id.id }}">{{ r.name }}</option>
                {% endfor %}
              </select>
            </div>

            <button type="submit" class="btn btn-success">Filter</button>
            <a href="{% url 'testing2:testing2' %}" class="btn btn-secondary">Reset</a>
          </form>
        </div>
      </div>

      <!-- Upload Tab -->
      <div class="tab-pane fade" id="upload" role="tabpanel" aria-labelledby="upload-tab">
        <div class="card p-4">
          <h5 class="fw-bold mb-3">Upload Dataset Baru</h5>
          <hr />

          <!-- FORM YANG BENAR -->
          <form method="POST" enctype="multipart/form-data" action="{% url 'testing2:upload_csv' %}" onsubmit="return validateFile()">
            {% csrf_token %}

            <!-- Nama/Deskripsi Data -->
            <div class="mb-3">
              <label for="description" class="form-label">Nama/Deskripsi Data</label>
              <input type="text" class="form-control" id="description" name="description" placeholder="Masukkan deskripsi dataset" required />
            </div>

            <!-- Input File CSV -->
            <div class="mb-3">
              <label for="datasetFile" class="form-label">Pilih File Dataset</label>
              <input type="file" class="form-control" id="datasetFile" name="datasetFile" accept=".csv" required />
              <div id="fileError" class="text-danger mt-1 d-none">Hanya file .csv yang diperbolehkan!</div>
            </div>

            <!-- Tombol Upload -->
            <button type="submit" class="btn btn-primary px-4">Upload</button>
          </form>
        </div>
      </div>

      <!-- Menampilkan tabel jika ada hasil -->
      <div class="container mt-5">
        <h4 class="mb-4">Hasil Prediksi: {{ result.desc }}</h4>
        <ul class="list-group">
          <li class="list-group-item">
            Prediksi Pendaftar: <strong>{{ result.pendaftar }}</strong>
          </li>
          <li class="list-group-item">
            Prediksi Pembayar: <strong>{{ result.bayar }}</strong>
          </li>
          <li class="list-group-item">
            Prediksi Enroll: <strong>{{ result.enroll }}</strong>
          </li>
        </ul>

        <!-- Simulasi Fitur -->
        {% comment %} <h5 class="mt-5">Simulasi Prediksi Berdasarkan Fitur</h5>
        <form method="POST" action="{% url 'testing2:upload_csv' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="description" value="{{ result.desc }}" />
          <input type="hidden" name="simulate_only" value="1" />

          <!-- Simulasi finalscore -->
          <div class="mb-3">
            <label class="form-label">Simulasikan Final Score</label>
            <select class="form-select" name="sim_finalscore">
              <option value="">Jangan diubah</option>
              <option value="0">Ubah semua ke 0 (jalur beasiswa)</option>
              <option value="1">Ubah semua ke 1 (jalur tes)</option>
            </select>
          </div>

          <!-- Simulasi idtipelulusanprofexe -->
          <div class="mb-3">
            <label class="form-label">Simulasikan Tipe Lulusan</label>
            <select class="form-select" name="sim_idtipelulusanprofexe">
              <option value="">Jangan diubah</option>
              <option value="0">Ubah semua ke 0 (kelas pagi)</option>
              <option value="1">Ubah semua ke 1</option>
              <option value="2">Ubah semua ke 2</option>
              <option value="3">Ubah semua ke 3</option>
            </select>
          </div>

          <!-- Submit -->
          <button class="btn btn-secondary">Simulasikan</button>
        </form>

        <!-- Tambahkan ini setelah hasil awal -->
        {% if result %}
          <div class="mt-5">
            <h5>Hasil Simulasi</h5>
            <ul class="list-group">
              <li class="list-group-item">
                Prediksi Pendaftar: <strong>{{ result.pendaftar }}</strong>
              </li>
              <li class="list-group-item">
                Prediksi Pembayar: <strong>{{ result.bayar }}</strong>
              </li>
              <li class="list-group-item">
                Prediksi Enroll: <strong>{{ result.enroll }}</strong>
              </li>
            </ul>
          </div>
        {% endif %}

        <a href="{% url 'testing2:testing2' %}" class="btn btn-warning mt-4">Upload Dataset Baru</a> {% endcomment %}

        {% if table %}
          <table class="table mt-4">
            <thead>
              <tr>
                <th>
                  {% if group_col == 'idcountrydata' %}
                    Negara
                  {% elif group_col == 'iddataprovinces' %}
                    Provinsi
                  {% elif group_col == 'iddataregencies' %}
                    Kabupaten/Kota
                  {% elif group_col == 'asalsekolah' %}
                    Asal Sekolah
                  {% else %}
                    Wilayah
                  {% endif %}
                </th>
                <th>Pendaftar</th>
                <th>Pembayar</th>
                <th>Enroll</th>
                <th>Total Enroll</th>
              </tr>
            </thead>
            <tbody>
              {% for row in table %}
                <tr>
                  <td>{{ row.group_col|floatformat:0 }}</td>
                  <td>{{ row.pendaftar|floatformat:2 }}</td>
                  <td>{{ row.pembayar|floatformat:2 }}</td>
                  <td>{{ row.enroll|floatformat:2 }}</td>
                  <td>{{ row.total_enroll|floatformat:2 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
        {% if regency_info %}
            <div class="alert alert-info">
                <strong>Kabupaten/kota yang tersedia di provinsi ini:</strong><br>
                <ul>
                    {% for item in regency_info %}
                        <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Script untuk Validasi File -->
  <script>
    function resetPrediction() {
      const result = document.getElementById('predictionResult')
      if (result) {
        result.remove() // hapus dari DOM
      }
    }
    
    function validateFile() {
      const fileInput = document.getElementById('datasetFile')
      const fileError = document.getElementById('fileError')
    
      if (!fileInput.value.endsWith('.csv')) {
        fileError.classList.remove('d-none')
        return false
      }
    
      fileError.classList.add('d-none')
      return true
    }
    
    function toggleProvince(val) {
      const provGroup = document.getElementById('provinsi-group')
      const regencyGroup = document.getElementById('kota-group')
    
      if (val === '105') {
        provGroup.style.display = 'block'
        regencyGroup.style.display = 'block'
      } else {
        provGroup.style.display = 'none'
        regencyGroup.style.display = 'none'
      }
    }
    
    function filterRegencies(provinsiId) {
      const allOptions = document.querySelectorAll('#regency option');
      allOptions.forEach((opt) => {
        if (!opt.value) return; // Lewati "Semua"
        const provId = opt.getAttribute('data-prov-id');
        if (!provinsiId) {
          opt.style.display = 'none';
        } else {
          opt.style.display = provId === provinsiId ? 'block' : 'none';
        }
      });
      document.getElementById('regency').value = ''; // Reset pilihan kabupaten
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      const selectedCountry = document.getElementById('country').value;
      const selectedProvinsi = document.getElementById('provinsi').value;
      toggleProvince(selectedCountry);
      filterRegencies(selectedProvinsi);

      {% if not result %}
        document.getElementById('country').disabled = true;
      {% else %}
        document.getElementById('country').disabled = false;
      {% endif %}
    });
  </script>
{% endblock %}
